---
title: "Symposium Exploration"
author: "Chase Brewster"
date: "2022-11-01"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```


#Install and Load Packages
```{r}
install.packages("tidyverse")
install.packages("ggplot2")
install.packages("extrafont")
install.packages("scales")
install.packages("gganimate")

library(tidyverse)
library(ggplot2)
library(extrafont)
library(scales)
library(gganimate)
font_import()


install.packages("zoo")
install.packages("lubridate")
install.packages("scales")
install.packages("ggthemes")
install.packages("gifski")
install.packages("png")
install.packages("extrafont")
install.packages("showtext")
install.packages("ragg")
install.packages("magick")
install.packages("gapminder")
install.packages("rsvg")
install.packages("png")
install.packages("ggimage")
install.packages("cowplot")
install.packages("systemfonts")
install.packages("anytime")

library(zoo)
library(scales)
library(ggthemes)
library(gifski)
library(png)
library(extrafont)
library(showtext)
library(magick)
library(gapminder)
library(rsvg)
library(png)
library(ggimage)
library(cowplot)
library(systemfonts)
library(anytime)
```

#Wrangling data to look at polymer breakdowns
```{r}
ccc_data <- read_csv("CCC_MonthlyDataLog_Responses.csv")

ccc_data <- head(ccc_data, 378) %>% 
  select(1:65)

summary(ccc_data)

ccc_data$AT <- as.numeric(ccc_data$AT)
ccc_data$AU <- as.numeric(ccc_data$AU)
ccc_data$AV <- as.numeric(ccc_data$AV)
ccc_data$AW <- as.numeric(ccc_data$AW)
ccc_data$AX <- as.numeric(ccc_data$AX)
ccc_data$AY <- as.numeric(ccc_data$AY)
ccc_data$AZ <- as.numeric(ccc_data$AZ)
ccc_data$BA <- as.numeric(ccc_data$BA)

ccc_data <- ccc_data %>% 
  rename(
    LDPE = AT,
    HDPE = AU,
    PP = AV,
    PVC = AW,
    PS = AX,
    Nylon = AY,
    Teflon = AZ,
    PET = BA
  )

#saving data
write_csv(ccc_data, file = "ccc_data.csv")
```

#Stacked bar graph to show the percentage breakdown of each polymer type by country
```{r}
#polymer by country visualization

ccc_data_polymer <- ccc_data %>% 
  select(C, D, E, LDPE, HDPE, PP, PVC, PS, Nylon, Teflon, PET) %>% 
  mutate(total = LDPE + HDPE + PP + PVC + PS + Nylon + Teflon + PET) %>% 
  mutate(LDPE_p = (LDPE/total)*100) %>%
  mutate(HDPE_p = (HDPE/total)*100) %>%
  mutate(PP_p = (PP/total)*100) %>%
  mutate(PVC_p = (PVC/total)*100) %>%
  mutate(PS_p = (PS/total)*100) %>%
  mutate(Nylon_p = (Nylon/total)*100) %>%
  mutate(Teflon_p = (Teflon/total)*100) %>%
  mutate(PET_p = (PET/total)*100)

summary(ccc_data_polymer)

ccc_data_polymer_short <- ccc_data %>% 
  select(C, D, E, LDPE, HDPE, PP, PVC, PS, Nylon, Teflon, PET) %>% 
  mutate(total = LDPE + HDPE + PP + PVC + PS + Nylon + Teflon + PET)

polymer_summary <- ccc_data_polymer_short %>% 
  group_by(E) %>% 
  summarise(
    LDPE = sum(LDPE, na.rm = TRUE),
    HDPE = sum(HDPE, na.rm = TRUE),
    PP = sum(PP, na.rm = TRUE),
    PVC = sum(PVC, na.rm = TRUE),
    PS = sum(PS, na.rm = TRUE),
    Nylon = sum(Nylon, na.rm = TRUE),
    Teflon = sum(Teflon, na.rm = TRUE),
    PET = sum(PET, na.rm = TRUE)
  )

polymer_summary <- polymer_summary[c(2, 4:10),]

polymer_summary_p <- polymer_summary %>% 
  mutate(total = LDPE + HDPE + PP + PVC + PS + Nylon + Teflon + PET) %>% 
  mutate(LDPE_p = (LDPE/total)*100) %>%
  mutate(HDPE_p = (HDPE/total)*100) %>%
  mutate(PP_p = (PP/total)*100) %>%
  mutate(PVC_p = (PVC/total)*100) %>%
  mutate(PS_p = (PS/total)*100) %>%
  mutate(Nylon_p = (Nylon/total)*100) %>%
  mutate(Teflon_p = (Teflon/total)*100) %>%
  mutate(PET_p = (PET/total)*100)

polymer_summary <- polymer_summary[c(1,2,4,5,7,8),]

polymer_pivot <- polymer_summary %>% 
  pivot_longer(
    cols = 2:9,
    names_to = "Polymer",
    values_to = "Total"
  )

polymer_pivot <- polymer_pivot %>% 
  group_by(E)

cbPalette <- c("#56B4E9", "#E69F00", "#CC79A7", "#009E73", "#999999", "#0072B2", "#D55E00", "#F0E442")

polymer_pivot <- polymer_pivot %>% 
  rename(Country = E)

polymer_pivot$Country <- factor(polymer_pivot$Country, levels = c("Kenya", "Ecuador", "Mexico", "Indonesia", "Thailand", "Vietnam"))

polymer_graph <- ggplot(polymer_pivot, aes(fill=Polymer, y = Total, x = Country, group = Total)) +
  geom_bar(position = "fill", stat = "identity", color = 'black', size = 0.2) +
  theme_classic() +
  scale_fill_manual(values=cbPalette_two) +
  ggtitle("Polymer Type (%) by Country\n") +
  xlab("\nCountry") +
  ylab("% of Plastic Collected (by weight)\n") +
  theme(plot.title = element_text(hjust = 0.5)) +
  scale_y_continuous(labels = percent, expand = c(0,0)) +
  annotate("text", label = "38.6%", x = 2, y = .19, color = 'white', size = 3, fontface = 'bold') +
  annotate("text", label = "39.4%", x = 4, y = .20, color = 'white', size = 3, fontface = 'bold') +
  annotate("text", label = "38.3%", x = 1, y = .19, color = 'white', size = 3, fontface = 'bold') +
  annotate("text", label = "65.9%", x = 3, y = .33, color = 'white', size = 3, fontface = 'bold') +
  annotate("text", label = "33.8%", x = 5, y = .16, color = 'white', size = 3, fontface = 'bold') +
  annotate("text", label = "54.4%", x = 6, y = .27, color = 'white', size = 3, fontface = 'bold') +
  annotate("text", label = "22.0%", x = 2, y = .50, color = 'white', size = 3, fontface = 'bold') +
  annotate("text", label = "33.0%", x = 4, y = .55, color = 'white', size = 3, fontface = 'bold') +
  annotate("text", label = "21.0%", x = 1, y = .49, color = 'white', size = 3, fontface = 'bold') +
  annotate("text", label = "31.0%", x = 3, y = .80, color = 'white', size = 3, fontface = 'bold') +
  annotate("text", label = "27.0%", x = 5, y = .48, color = 'white', size = 3, fontface = 'bold') +
  annotate("text", label = "15.8%", x = 6, y = .62, color = 'white', size = 3, fontface = 'bold') +
  annotate("text", label = "20.5%", x = 2, y = .71, color = 'white', size = 3, fontface = 'bold') +
  annotate("text", label = "25.3%", x = 4, y = .85, color = 'white', size = 3, fontface = 'bold') +
  annotate("text", label = "13.6%", x = 1, y = .66, color = 'white', size = 3, fontface = 'bold') +
  annotate("text", label = "25.2%", x = 5, y = .73, color = 'white', size = 3, fontface = 'bold') +
  annotate("text", label = "12.5%", x = 6, y = .76, color = 'white', size = 3, fontface = 'bold') +
  annotate("text", label = "10.1%", x = 1, y = .78, color = 'white', size = 3, fontface = 'bold') +
  annotate("text", label = "15.3%", x = 2, y = .89, color = 'white', size = 3, fontface = 'bold')

polymer_graph

ggsave("polymer_graph.png")

class(polymer_pivot$Polymer)

polymer_pivot$Polymer <- as.factor(polymer_pivot$Polymer)

polymer_pivot$Polymer <- factor(polymer_pivot$Polymer, levels = c("Nylon", "Teflon","PVC", "LDPE", "PS", "PP","HDPE","PET"))

cbPalette_two <- c("#CC79A7", "#F0E442", "#D55E00", "#E69F00", "#0072B2", "#999999", "#56B4E9", "#009E73")

polymer_graph_alt <- ggplot(polymer_pivot, aes(fill = Polymer, y = Total, x = Country, group = Polymer)) +
  geom_bar(position = "fill", stat = "identity", color = 'black', size = 0.2) +
  theme_classic() +
  scale_fill_manual(values=cbPalette_two) +
  ggtitle("Polymer Type (%) by Country\n") +
  xlab("\nCountry") +
  ylab("% of Plastic Collected (by weight)\n") +
  theme(plot.title = element_text(hjust = 0.5)) +
  scale_y_continuous(labels = percent, expand = c(0,0)) +
  guides(fill=guide_legend(title="Polymer")) +
  annotate("text", label = "20.5%", x = 2, y = .11, color = 'white', size = 3, fontface = 'bold') +
  annotate("text", label = "33.0%", x = 4, y = .19, color = 'white', size = 3, fontface = 'bold') +
  annotate("text", label = "38.3%", x = 1, y = .19, color = 'white', size = 3, fontface = 'bold') +
  annotate("text", label = "65.9%", x = 3, y = .33, color = 'white', size = 3, fontface = 'bold') +
  annotate("text", label = "33.8%", x = 5, y = .16, color = 'white', size = 3, fontface = 'bold') +
  annotate("text", label = "12.5%", x = 6, y = .065, color = 'white', size = 3, fontface = 'bold') +
  annotate("text", label = "38.6%", x = 2, y = .39, color = 'white', size = 3, fontface = 'bold') +
  annotate("text", label = "39.4%", x = 4, y = .55, color = 'white', size = 3, fontface = 'bold') +
  annotate("text", label = "21.0%", x = 1, y = .49, color = 'white', size = 3, fontface = 'bold') +
  annotate("text", label = "31.0%", x = 3, y = .80, color = 'white', size = 3, fontface = 'bold') +
  annotate("text", label = "27.0%", x = 5, y = .48, color = 'white', size = 3, fontface = 'bold') +
  annotate("text", label = "15.8%", x = 6, y = .30, color = 'white', size = 3, fontface = 'bold') +
  annotate("text", label = "15.3%", x = 2, y = .71, color = 'white', size = 3, fontface = 'bold') +
  annotate("text", label = "25.3%", x = 4, y = .86, color = 'white', size = 3, fontface = 'bold') +
  annotate("text", label = "10.1%", x = 1, y = .645, color = 'white', size = 3, fontface = 'bold') +
  annotate("text", label = "25.2%", x = 5, y = .73, color = 'white', size = 3, fontface = 'bold') +
  annotate("text", label = "54.4%", x = 6, y = .65, color = 'white', size = 3, fontface = 'bold') +
  annotate("text", label = "13.6%", x = 1, y = .81, color = 'white', size = 3, fontface = 'bold') +
  annotate("text", label = "22.0%", x = 2, y = .89, color = 'white', size = 3, fontface = 'bold')

polymer_graph_alt

showtext_auto(enable = FALSE)

ggsave("polymer_graph_alt.png")
```

#Recreate the animate GIF of cumulative plastic over time
```{r}

total_plastic_data <- ccc_data %>% 
  select(F, E, C, D, AA, AB) %>% 
  mutate(Plastic = ifelse(is.na(AB)| AB == 0, AA, AB))

total_plastic_data <- total_plastic_data %>% 
  rename(
    Organization = F,
    Country = E,
    Month = C,
    Year = D,
    Wet = AA,
    Dry = AB
  )

total_plastic_data <- total_plastic_data[2:378,]


total_plastic_data <- total_plastic_data %>% 
  mutate(Month_code = case_when(total_plastic_data$Month == "January" ~ "01",
                                total_plastic_data$Month == "February" ~ "02",
                                total_plastic_data$Month == "March" ~ "03",
                                total_plastic_data$Month == "April" ~ "04",
                                total_plastic_data$Month == "May" ~ "05",
                                total_plastic_data$Month == "June" ~ "06",
                                total_plastic_data$Month == "July" ~ "07",
                                total_plastic_data$Month == "August" ~ "08",
                                total_plastic_data$Month == "September" ~ "09",
                                total_plastic_data$Month == "October" ~ "10",
                                total_plastic_data$Month == "November" ~ "11",
                                total_plastic_data$Month == "December" ~"12"))

total_plastic_data$Date <- paste(total_plastic_data$Year, total_plastic_data$Month_code, "01", sep="-")

total_plastic_data <- total_plastic_data %>% 
  select(Organization, Country, Month, Year, Date, Plastic)

total_plastic_data$Date <- as.Date(total_plastic_data$Date)

total_plastic_data <- total_plastic_data[order(as.Date(total_plastic_data$Date, format="%Y/%m/%d")),]

class(total_plastic_data$Plastic)

total_plastic_data$Plastic <- as.numeric(total_plastic_data$Plastic)

total_plastic_data <- total_plastic_data %>%
  drop_na(Plastic) %>% 
  group_by(Date)

plastic_sum <- total_plastic_data %>%
  group_by(Date) %>% 
  summarise(plastic_sum=sum(Plastic))

plastic_sum$Plastic_c <- cumsum(plastic_sum$plastic_sum)

sum_line <- ggplot(plastic_sum, aes(x=Date, y=Plastic_c)) +
  geom_line()

sum_line

sum_an <- sum_line +
  transition_reveal(Date) +
  view_follow()

animate(sum_an, height=365,width=608,fps=30,duration=10,end_pause = 120,res=100,rewind=F)

font.add("Interbold", "Inter-Bold.ttf")
showtext_auto()
font_import()
font_files()
fonts()
font_paths()
logo_white <- grid::rasterGrob(readPNG("CleanCurrentsCoalition_logo_vertical_1c_rev.png"))
logo_circle <- grid::rasterGrob(readPNG("CleanCurrentsCoalition_logo_circle_3c.png"))


getwd()

water_bottle <- rep(c("/Users/brewster/Documents/CCC/Data/ccc_500k_milestone/waterbottle.png"),28)

plastic_sum$Image <- water_bottle

class(plastic_sum$Date)

plastic_sum$Date <- as.Date(plastic_sum$Date)

is.recursive(plastic_sum)

plastic_sum <- plastic_sum %>% 
  mutate(Caption = format(anytime(plastic_sum), format = "%b %Y"))

class(plastic_sum$Plastic_c)

plastic_sum$Caption <- c("June 2020", "July 2020", "August 2020", "September 2020", "October 2020","November 2020", "December 2020", "January 2021", "February 2021", "March 2021", "April 2021", "May 2021", "June 2021", "July 2021", "August 2021", "September 2021", "October 2021", "November 2021", "December 2021", "January 2022", "February 2022", "March 2022", "April 2022", "May 2022", "June 2022", "July 2022", "August 2022", "September 2022")

plastic_sum$Label <- format(comma(round(plastic_sum$Plastic_c,0)))

plastic_sum <- plastic_sum %>% 
  rename(
    Labels = Label
  )

class(plastic_sum$Labels)

plastic_sum$Labels <- as.factor(plastic_sum$Labels)

write_csv(plastic_sum, file = "plastic_sum_animate_data.csv")

summary(plastic_sum)

plastic_viz <- ggplot(plastic_sum, aes(x=Date, y=Plastic_c)) +
  geom_line(color = "#043F67", size = 2) +
  scale_x_date(date_labels = "%b %Y", date_breaks = "2 month") +
  scale_y_continuous(breaks = seq(0, 900000, 100000), labels = comma) +
  theme(axis.text.x = element_text(angle = -45, hjust = -.1, family = "Inter", color ="white", size = 10, face = "bold")) +
  labs(title = "\n\nGlobal Plastic Captured\n\n",
       x = "\n\nDate\n\n",
       y = "\n\nPlastic Weight (kg)\n\n") +
  theme(axis.title.x = element_text(family ="Inter", face = "bold", color = "white", size = 16)) +
  theme(axis.title.y = element_text(family = "Inter", face = "bold", color = "white", size = 16)) +
  annotation_custom(logo_circle, ymin = 450000, ymax = 820000, xmax = as.Date("2021-07-01")) +
  theme(plot.title = element_text(family = "Inter", face = "bold", color = "white", size = 22, hjust = 0.5)) +
  theme(plot.background = element_rect(fill = "#0072A6")) +
  theme(panel.background = element_rect(fill = "White", color = "#043F67")) + 
  theme(axis.text.y = element_text(color = "white", size = 10, face = "bold")) +
  theme(plot.margin = unit(c(0,1.2,0,0), "cm")) +
  theme(panel.grid.minor.y = element_line(color = "#0072A6", size = 0.05),
        panel.grid.major.y = element_line(color = "#58B9DB", size = 0.3),
        panel.grid.major.x = element_blank(),
        panel.grid.minor.x = element_blank()) +
  geom_image(aes(image=Image), size = 0.07, by = "height") +
  scale_size_identity() +
  geom_text(aes(label = Caption), x = as.Date("2022-05-01"), y = 25000, color = "#043F67", family= "Inter", fontface = "bold", size = 6) +
  geom_text(aes(label = Labels), x = as.Date("2022-05-01"), y = 75000, color = "#58B9DB", family = "Inter", fontface = "bold", size = 5) +
  geom_point(size = 0.1, color = "white") +
  expand_limits(x = as.Date("2022-10-01"), y = 900000)

plastic_viz

plastic_viz_animate <- plastic_viz +
  transition_reveal(Date) +
  view_follow(fixed_y = T, fixed_x = T) +
  ease_aes('sine-in-out')

animate_viz <- animate(plastic_viz_animate, fps = 20, duration = 30, start_pause = 30, end_pause = 60, height = 600, width = 650)

animate_viz

anim_save("plastic_viz_final.gif", animate_viz)
```

